# Next.js 15 + Drizzle-Zod Example

This example demonstrates how to use **next-openapi-gen** with **Drizzle ORM** and **drizzle-zod** to automatically generate OpenAPI 3.0 documentation from your Next.js API routes.

## Features

- ✅ **Drizzle ORM** - Type-safe PostgreSQL database queries
- ✅ **drizzle-zod** - Auto-generated Zod schemas from Drizzle table definitions
- ✅ **next-openapi-gen** - Automatic OpenAPI 3.0 specification generation
- ✅ **Scalar UI** - Modern, interactive API documentation
- ✅ **Full CRUD API** - Complete blog posts API example

## Tech Stack

- **Next.js 15** - React framework with App Router
- **Drizzle ORM** - TypeScript ORM for PostgreSQL
- **drizzle-zod** - Zod schema generator for Drizzle tables
- **Zod** - TypeScript-first schema validation
- **next-openapi-gen** - OpenAPI documentation generator
- **Scalar** - API documentation UI

## Getting Started

### 1. Install Dependencies

```bash
npm install
```

### 2. Generate OpenAPI Specification

```bash
npm run openapi:generate
```

This will scan your API routes and generate `public/openapi.json` based on:

- Drizzle table definitions in `src/db/schema.ts`
- Zod schemas generated by drizzle-zod in `src/schemas/`
- JSDoc comments in your API route handlers

### 3. Start Development Server

```bash
npm run dev
```

### 4. View API Documentation

Open [http://localhost:3000/api-docs](http://localhost:3000/api-docs) to see the interactive API documentation powered by Scalar.

## Project Structure

```
src/
├── app/
│   ├── api/
│   │   └── posts/
│   │       ├── route.ts          # GET /api/posts, POST /api/posts
│   │       └── [id]/
│   │           └── route.ts      # GET/PATCH/DELETE /api/posts/:id
│   ├── api-docs/
│   │   └── page.tsx              # API documentation page (Scalar UI)
│   └── page.tsx                  # Home page
├── db/
│   └── schema.ts                 # Drizzle table definitions
└── schemas/
    └── post.ts                   # Zod schemas generated with drizzle-zod
```

## How It Works

### 1. Define Database Schema with Drizzle

```typescript
// src/db/schema.ts
import {
  pgTable,
  serial,
  varchar,
  text,
  boolean,
  timestamp,
} from "drizzle-orm/pg-core";

export const posts = pgTable("posts", {
  id: serial("id").primaryKey(),
  title: varchar("title", { length: 255 }).notNull(),
  content: text("content").notNull(),
  published: boolean("published").default(false),
  createdAt: timestamp("created_at").defaultNow(),
});
```

### 2. Generate Zod Schemas with drizzle-zod

```typescript
// src/schemas/post.ts
import { createInsertSchema, createSelectSchema } from "drizzle-zod";
import { posts } from "@/db/schema";

export const CreatePostSchema = createInsertSchema(posts, {
  title: (schema) => schema.title.min(5).max(255),
  content: (schema) => schema.content.min(10),
});

export const PostResponseSchema = createSelectSchema(posts);
```

### 3. Use Schemas in API Routes with JSDoc

```typescript
// src/app/api/posts/route.ts
/**
 * Create a new post
 * @description Create a new blog post with validation
 * @body CreatePostSchema
 * @response 201:PostResponseSchema
 * @openapi
 */
export async function POST(request: NextRequest) {
  const body = await request.json();
  const validated = CreatePostSchema.parse(body);
  // ... create post
}
```

### 4. Generate OpenAPI Documentation

```bash
npm run openapi:generate
```

The tool will:

1. Scan your API routes
2. Parse JSDoc comments
3. Process drizzle-zod schemas
4. Generate complete OpenAPI 3.0 specification

## Configuration

The `next.openapi.json` file in the root directory controls the documentation generation:

```json
{
  "openapi": "3.0.0",
  "info": {
    "title": "Drizzle-Zod Blog API",
    "version": "1.0.0"
  },
  "schemaDir": "src/schemas",
  "schemaType": "zod",
  "outputFile": "openapi.json"
}
```

## Available Scripts

- `npm run dev` - Start development server
- `npm run build` - Build for production
- `npm run start` - Start production server
- `npm run openapi:generate` - Generate OpenAPI specification
- `npm run db:generate` - Generate Drizzle migrations
- `npm run db:migrate` - Run Drizzle migrations
- `npm run db:studio` - Open Drizzle Studio

## API Endpoints

| Method | Endpoint         | Description       |
| ------ | ---------------- | ----------------- |
| GET    | `/api/posts`     | List all posts    |
| POST   | `/api/posts`     | Create a new post |
| GET    | `/api/posts/:id` | Get post by ID    |
| PATCH  | `/api/posts/:id` | Update post       |
| DELETE | `/api/posts/:id` | Delete post       |

## Learn More

- [next-openapi-gen Documentation](https://github.com/tazo90/next-openapi-gen)
- [Drizzle ORM](https://orm.drizzle.team/)
- [drizzle-zod](https://orm.drizzle.team/docs/zod)
- [Zod Documentation](https://zod.dev/)
- [Scalar Documentation](https://docs.scalar.com/)

## License

MIT
